{
  "hash": "79fd1fd527f658ddb0cd104499fb0a0a",
  "result": {
    "markdown": "---\ntitle: \"07 SPTRS_Creation\"\nauthor: \"Natasha Santhanam\"\ndate: \"2/7/2022\"\noutput: html_document\n---\n\n\n\n\n## Script to run Lassosum PTRS (Summary Statistics PTRS) on GTEx data for Height \n\nSet up the conda environment\n\n::: {.cell}\n\n```{.bash .cell-code}\nconda env create -f environment.yml\n\n# to activate: conda activate SPrediXcan2PTRS\n```\n:::\n\n\n# Calculate Genotype Covariances using GTEx genotypes and \n\nWe'll use Whole Blood as the prediction model since the individual PTRS weights were also trained in Whole Blood\n\nTo calculate genotype covariances you need the genotype as a vcf format, prediction model and sample list. \n\n\n::: {.cell}\n\n```{.bash .cell-code}\n#PBS -S /bin/bash\n#PBS -l walltime=24:00:00\n#PBS -l nodes=1:ppn=1\n#PBS -l mem=32gb\n#PBS -e /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/PTRS_weights/logs/gtex_v8_en_geno_cov/$TISSUE.${PBS_JOBID}.err\n#PBS -o /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/PTRS_weights/logs/gtex_v8_en_geno_cov/$TISSUE.${PBS_JOBID}.log\n\n\nsource ~/.bash_profile\nsource ~/.bashrc\n\nconda activate SPrediXcan2PTRS\n\n# load extra python dependency\nexport PYTHONPATH=/gpfs/data/im-lab/nas40t2/yanyul/GitHub/SPrediXcan2PTRS\nexport PYTHONPATH=/gpfs/data/im-lab/nas40t2/yanyul/GitHub/transethnic_prs\n\n# script path \ngen_script=/gpfs/data/im-lab/nas40t2/yanyul/GitHub/SPrediXcan2PTRS/generate_gtex_v8_geno_cov.py\n\n# input data\ngenotype=/gpfs/data/gtex-group/v8/59348/gtex/exchange/GTEx_phs000424/exchange/analysis_releases/GTEx_Analysis_2017-06-05_v8/genotypes/WGS/variant_calls/GTEx_Analysis_2017-06-05_v8_WholeGenomeSeq_838Indiv_Analysis_Freeze.SHAPEIT2_phased.vcf.gz\npredictdb=/gpfs/data/im-lab/nas40t2/Data/PredictDB/GTEx_v8/models_v1/eqtl/ctimp/ctimp_$TISSUE.db\neursample=/gpfs/data/im-lab/nas40t2/Data/GTEx/V8/eur_samples.txt\n\n# output\noutdir=/scratch/nsanthanam1/Lassosum_PTRS/geno_cov\nprefix=ctimp_$TISSUE.geno_cov\n\ncd /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/PTRS_weights/logs/\n\npython $gen_script \\\n  --genotype_vcf $genotype \\\n  --predictdb $predictdb \\\n  --mode evd 0 \\\n  --sample_list $eursample \\\n  --output_prefix $outdir/$prefix > \\\n  gtex_v8_en_geno_cov/$TISSUE.${PBS_JOBID}.log 2>&1\n```\n:::\n\n\nSubmit the script and define tissue\n\n::: {.cell}\n\n```{.bash .cell-code}\ntissue=Whole_Blood\nqsub -v TISSUE=$tissue geno_cov_PTRS.pbs \n```\n:::\n\n\n\n# Calculate Summary PTRS weights\n\nThis is a large submission script but there are two main parts: 1. Run S-PrediXcan 2. Calculate Lassosum PTRS. The inputs here are the number of people in the GWAS (GWASN), Tissue and GWAS Tag. This script takes the gwas (UKB Standing Height), prediction model (ctimpt Whole Blood) same as before and genotype covariances calculated above and generates a meta results file and a h5 file with the weights for each gene per model. \n\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n#PBS -S /bin/bash\n#PBS -l walltime=24:00:00\n#PBS -l nodes=1:ppn=1\n#PBS -l mem=32gb\n#PBS -e /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/PTRS_weights/logs/run_Muscle_Skeletal.${PBS_JOBID}.err\n#PBS -o /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/PTRS_weights/logs/run_Muscle_Skeletal.${PBS_JOBID}.log\n\n# ARGS:\n# TISSUE\n# GWASTAG\n# GWASN\n\nif [[ -z $TISSUE ]]\nthen\n  TISSUE=$1\n  GWASTAG=$2\n  GWASN=$3\n  PBS_O_WORKDIR=/gpfs/data/im-lab/nas40t2/natasha/SPrediXcan2PTRS\nfi\n\nsource ~/.bash_profile\nsource ~/.bashrc\n\npredict_db=/gpfs/data/im-lab/nas40t2/Data/PredictDB/GTEx_v8/models_v1/eqtl/ctimp/ctimp_${TISSUE}.db\npredict_db_cov=/gpfs/data/im-lab/nas40t2/Data/PredictDB/GTEx_v8/models_v1/eqtl/ctimp/ctimp_${TISSUE}.txt.gz\ngwas=/gpfs/data/im-lab/nas40t2/Data/SummaryResults/imputed_gwas_hg38_1.1/imputed_UKB_50_${GWASTAG}.txt.gz\noutdir=/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur\n\nexport PYTHONPATH=/gpfs/data/im-lab/nas40t2/yanyul/GitHub/SPrediXcan2PTRS\nexport PYTHONPATH=/gpfs/data/im-lab/nas40t2/yanyul/GitHub/transethnic_prs\n\nconda activate /gpfs/data/im-lab/nas40t2/bin/envs/imlabtools/\n\n\n# impute beta and se from z\nimputeb_gwas=$outdir/imputed_bhat.${GWASTAG}.txt.gz\nif [[ ! -f $imputeb_gwas ]]\nthen\n  echo \"Imputing effect size of GWAS\"\n  echo \"Input: $gwas\"\n  echo \"Output: $imputeb_gwas\"\n  python /gpfs/data/im-lab/nas40t2/natasha/SPrediXcan2PTRS/misc_scripts/run_gtex_gwas/impute_b_for_gwas.py \\\n    --input $gwas \\\n    --zscore zscore \\\n    --freq frequency \\\n    --sample_size sample_size \\\n    --output $imputeb_gwas\nfi\n\n\n# run s-predixcan\nspxcanscript=/gpfs/data/im-lab/nas40t2/yanyul/GitHub/MetaXcan/software/SPrediXcan.py\npxcan_file=$outdir/spredixcan.${GWASTAG}.${TISSUE}.csv\nif [[ ! -f $pxcan_file ]]\nthen\n  echo \"Running S-PrediXcan\"\n  echo \"Input: $imputeb_gwas\"\n  echo \"Output: $pxcan_file\"\n  python $spxcanscript \\\n    --gwas_file $imputeb_gwas \\\n    --snp_column variant_id \\\n    --effect_allele_column effect_allele \\\n    --non_effect_allele_column non_effect_allele \\\n    --beta_column effect_size \\\n    --se_column standard_error \\\n    --model_db_path $predict_db \\\n    --covariance $predict_db_cov \\\n    --additional_output \\\n    --throw \\\n    --output_file $pxcan_file\nfi\n\n# run SPrediXcan2PTRS\nconda activate SPrediXcan2PTRS\n\nrunscript=/gpfs/data/im-lab/nas40t2/natasha/SPrediXcan2PTRS/run_pxcan2ptrs.py\n\ngeno_cov_file=/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/ctimp_$TISSUE.geno_cov.chr{chr_num}.evd.npz\n\nptrs_prefix=$outdir/spxcan2ptrs_original_scale.${GWASTAG}.${TISSUE}\nptrs_file=$ptrs_prefix.results.h5\n\nif [[ ! -f $ptrs_file ]]\nthen\n  echo \"Running SPrediXcan2PTRS\"\n  echo \"Input: $pxcan_file\"\n  echo \"Output: $ptrs_file\"\n  python $runscript \\\n    --predixcan $pxcan_file \\\n    --predictdb $predict_db \\\n    --geno_cov $geno_cov_file \\\n    --gwas $gwas \\\n    --gwas_cols chromosome=chromosome \\\n      position=position \\\n      effect_allele=effect_allele \\\n      non_effect_allele=non_effect_allele \\\n    --gwas_sample_size $GWASN \\\n    --output_prefix $ptrs_prefix \\\n    --original_scale\nfi\n\n\nptrs_prefix=$outdir/spxcan2ptrs_clump_original_scale.${GWASTAG}.${TISSUE}\nptrs_file=$ptrs_prefix.results.h5\n\nif [[ ! -f $ptrs_file ]]\nthen\n  echo \"Running SPrediXcan2PTRS\"\n  echo \"Input: $pxcan_file\"\n  echo \"Output: $ptrs_file\"\n  python $runscript \\\n    --predixcan $pxcan_file \\\n    --predictdb $predict_db \\\n    --geno_cov $geno_cov_file \\\n    --gwas $gwas \\\n    --gwas_cols chromosome=chromosome \\\n      position=position \\\n      effect_allele=effect_allele \\\n      non_effect_allele=non_effect_allele \\\n    --gwas_sample_size $GWASN \\\n    --output_prefix $ptrs_prefix \\\n    --original_scale \\\n    --clump\nfi\n```\n:::\n\n\nSubmit the script with all the inputs\n\n::: {.cell}\n\n```{.bash .cell-code}\ngwastag=Standing_height\ntissue=Whole_Blood\nnsample=336474\nqsub -v TISSUE=$tissue,GWASTAG=$gwastag,GWASN=$nsample -N $nsample run_LassoSum_PTRS.pbs  \n```\n:::\n\n\nSave the Results as a txt file so it's easier to work with in R\n\n::: {.cell}\n\n```{.python .cell-code}\nimport h5py\nimport numpy as np\n\nf = h5py.File('/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs_clump_original_scale.Standing_height.Whole_Blood.results.h5', 'r')   \n#f = h5py.File('/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs_original_scale.Standing_height.Whole_Blood.results.h5', 'r')\n\nf.keys()\nf['dataset_0'].keys()\n\nweights = f['dataset_0']['betahat'][...]\nn1 = np.array(f[\"genes\"][:])\n\nnp.savetxt('/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs.clump.Standing_height.Whole_Blood.results.tsv', weights, delimiter='\\t')\n#np.savetxt('/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs.lassosum.Standing_height.Whole_Blood.results.tsv', weights, delimiter='\\t')\n\nnp.savetxt('/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs.clump.Standing_height.Whole_Blood.genes.tsv', n1, fmt='%s')\n#np.savetxt('/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs.lassosum.Standing_height.Whole_Blood.genes.tsv', n1, fmt='%s')\n```\n:::\n\n\nAdd gene name to weights file\n\n::: {.cell}\n\n```{.r .cell-code}\nweights <- read_tsv(\"/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs.clump.Standing_height.Whole_Blood.results.tsv\", col_names = FALSE)\n\ngene_ids <- read_tsv(\"/scratch/nsanthanam1/Lassosum_PTRS/geno_cov/run_gtex_gwas_eur/spxcan2ptrs.clump.Standing_height.Whole_Blood.genes.tsv\", col_names = FALSE)\ngene_ids$X1 <- substr(gene_ids$X1, 3, str_length(gene_ids$X1) -1 )\n\nweights <- weights %>% mutate(gene_name = gene_ids$X1, .before = colnames(weights)[1])\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}