{
  "hash": "549ba456f654634bc319c1bfa2d35876",
  "result": {
    "markdown": "---\ntitle: \"Rat_QC_Merging\"\nauthor: \"Natasha Santhanam\"\ndate: \"2/14/2022\"\noutput: html_document\n---\n\n---\ntitle: \"Rat QC and Comparison Check\"\nauthor: \"Natasha Santhanam\"\ndate: \"10/26/2021\"\noutput: html_document\n---\n\n\n\n\n## Compare the overlap of Rats between the original 80 and new ones sent by Apurva\n\nApurva sent bimbam files that I converted to map/ped and then bim/bed/fam files using my own pipeline. Pipeline is in rat_compare_genotypes_metabolic.Rmd file.\n\n# Cleanup\n\nQC for Missingness in Apurva's data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplink --bfile rat_metabolic_impute --missing --out rat_metabolic_missing\n \n#can also check missingness in Tyson's rats - shouldn't be since genotypes are imputed\nplink --bfile rat_geno_merged_Ac --missing --out rat_Ac_missing\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Missingess in Apurva's dataset\nindmiss<-read.table(file= data.dir %&% \"rat_metabolic_missing.imiss\", header=TRUE)\nsnpmiss<-read.table(file= data.dir %&% \"rat_metabolic_missing.lmiss\", header=TRUE)\n\nsummary(indmiss$N_MISS)\nsummary(snpmiss$N_MISS)\n\n#Missingness in Tyson's rats\nindmiss<-read.table(file= data.dir %&% \"rat_Ac_missing.imiss\", header=TRUE)\nsnpmiss<-read.table(file= data.dir %&% \"rat_Ac_missing.lmiss\", header=TRUE)\n\nsummary(indmiss$N_MISS)\nsummary(snpmiss$N_MISS)\n```\n:::\n\n\nAs we expected since this is all imputed data, there are no snps missing across individuals or individuals missing\n\n\nBefore merging, I'll mark the ids of the Fam file from the original 80 so that way we can identify them later. This is in CRI. All the genotypes are in  /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/Box_files/rat_genotypes_LD_pruned_0.95/plink_format/\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfam <- read.table(\"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/genotype_files/rat_genotype_Ac.fam\")\nfam$V1 <- paste(fam$V1, \"T\", sep = \"_\")\nfam$V2 <- fam$V1\nwrite.table(fam, geno.dir %&% \"plink_format/rat_geno_merged_Ac.fam\", col.names=FALSE, row.names=FALSE, quote=FALSE)\n```\n:::\n\n\n\nAlso, I have to edit the varID in the bim file for the original 80 rats. The varID is {chr}_{pos}_{ref}_{alt} and in the 3000 rats bim file it's chr{}:{pos} \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbim <- read.table(\"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/genotype_files/rat_genotype_Ac.bim\")\nbim$V2 <- paste(paste(\"chr\", bim$V1, sep= \"\"), bim$V4, sep = \":\")\nwrite.table(bim, geno.dir %&% \"plink_format/rat_geno_merged_Ac.bim\", col.names=FALSE, row.names=FALSE, quote=FALSE)\n```\n:::\n\n\n\n# Merge the both rat genotype data sets\n\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n# Remove variants based on MAF.\nplink --bfile rat_metabolic_impute --maf 0.05 --allow-no-sex --make-bed --out rat_metabolic_impute_maf\n\n# Extract the variants present in 80 rats from the 3000 rats genomes dataset.\nawk '{print$2}' rat_geno_merged_Ac.bim > rat_geno_Ac_SNPs.txt\nplink --bfile rat_metabolic_impute_maf --extract rat_geno_Ac_SNPs.txt --make-bed --out rat_metabolic_impute_same_snps\n\n# Extract the variants present in 3000 rats Genomes dataset from the 80 rats dataset.\nawk '{print$2}' rat_metabolic_impute.bim > rat_metabolic_SNPs.txt\nplink --bfile rat_geno_merged_Ac --extract rat_metabolic_SNPs.txt --recode --make-bed --out rat_geno_merged_Ac_same_snps\n# The datasets now contain the exact same variants.\n\n## The datasets must have the same build. Change the build 3000 rats Genomes data build.\nawk '{print$2,$4}' rat_metabolic_impute.map  > buildratmetabolic.txt\n# buildratmetabolic.txt contains one SNP-id and physical position per line.\n\nplink --bfile rat_geno_merged_Ac_same_snps --update-map buildratmetabolic.txt --make-bed --out rat_geno_merged_Ac_same_build\n# both files  now have the same build.\n```\n:::\n\n\n\n Prior to merging,  want to make sure that the files are mergeable, for this we conduct 3 steps:\n \n \n1) Make sure the reference genome is similar in the 80 rat plink files and the 3000 rat datasets.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nawk '{print$2,$5}' rat_geno_merged_Ac_same_build.bim > rat_Ac_ref-list.txt\n\nplink --bfile rat_metabolic_impute_same_snps --reference-allele rat_Ac_ref-list.txt --make-bed --out rat_metabolic-adj\n```\n:::\n\n\n2) Resolve strand issues.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n# Check for potential strand issues.\nawk '{print$2,$5,$6}' rat_geno_merged_Ac_same_build.bim > rat_genotype_Ac-adj_tmp\nawk '{print$2,$5,$6}' rat_metabolic-adj.bim > rat_metabolic_impute_tmp \nsort rat_metabolic_impute_tmp rat_genotype_Ac-adj_tmp |uniq -u > all_differences.txt\n# 366 differences between the files, some of these might be due to strand issues.\n```\n:::\n\n::: {.cell}\n\n```{.bash .cell-code}\n# Print SNP-identifier and remove duplicates.\nawk '{print$1}' all_differences.txt | sort -u > flip_list.txt\n# Generates a file of 366 SNPs. These are the non-corresponding SNPs between the two files. \n# Flip the 366 non-corresponding SNPs. \n\nplink --bfile rat_metabolic-adj --flip flip_list.txt --reference-allele rat_Ac_ref-list.txt --make-bed --out corrected_rat_metabo\n\n# Check for SNPs which are still problematic after they have been flipped.\nawk '{print$2,$5,$6}' corrected_rat_metabo.bim > corrected_rat_metab_tmp\nsort rat_genotype_Ac-adj_tmp corrected_rat_metab_tmp |uniq -u  > uncorresponding_SNPs.txt\n```\n:::\n\n\n3) Remove the SNPs which after the previous two steps still differ between datasets.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nawk '{print$1}' uncorresponding_SNPs.txt | sort -u > SNPs_for_exlusion.txt\n# The command above generates a list of the 366 SNPs\n\n# Remove problematic SNPs from both datasets.\nplink --bfile corrected_rat_metabo --exclude SNPs_for_exlusion.txt --make-bed --out rat_metabolic_corr \n\nplink --bfile rat_geno_merged_Ac_same_build --exclude SNPs_for_exlusion.txt --make-bed --out rat_geno_Ac_MDS2\n\n# Merge original rat file with rat metabolic phenotype Data.\nplink --bfile rat_metabolic_corr --bmerge rat_geno_Ac_MDS2.bed rat_geno_Ac_MDS2.bim rat_geno_Ac_MDS2.fam --allow-no-sex --make-bed --out all_rats_merged\n```\n:::\n\n\nAfter all of this I generated a set of plink files all_rats_merged with 3551 rats (3473 + 78). Next, I'll generate the GRM using GCTA \n\n\n# Generate GRM for both merged rats and only for the 3000\n\n::: {.cell}\n\n```{.bash .cell-code}\ngcta --bfile rat_metabolic_impute --make-grm-bin --out rat_metabolic_grm\n```\n:::\n\n\n\nThis is done in CRI and in this folder /gpfs/data/im-lab/nas40t2/natasha/rat_genomics/Box_files/rat_genotypes_LD_pruned_0.95/plink_format/GRMs\n\n::: {.cell}\n\n```{.bash .cell-code}\ngcta --bfile all_rats_merged --make-grm-bin --out all_rats_grm\n```\n:::\n\n\nNext we can read in the GRM using the readGRM function\n\n\n\n\n\nHere is the histogram of both the diagonal and off diagonal GRM for the 3000 rats before ever merging\n\n::: {.cell}\n\n```{.r .cell-code}\nrats_metabolic_GRM <- ReadGRMBin(data.dir %&% \"rat_metabolic_grm\")\ndiag <- as.data.frame(rats_metabolic_GRM$diag) %>% rename(val = `rats_metabolic_GRM$diag`)\nggplot(diag, aes(x = val)) + geom_histogram(binwidth = 0.01, colour=\"black\", fill=\"white\") + labs(title = \"Histogram of Diagonal of GRM of original 3473 rats before merging\", x= \"Diagonal\", y = \"Count\")\n\noff <- as.data.frame(rats_metabolic_GRM$off) %>% rename(val = `rats_metabolic_GRM$off`)\nggplot(off, aes(x = val)) + geom_histogram(binwidth = 0.01, colour=\"black\", fill=\"white\") + labs(title = \"Histogram of Off - Diagonal of GRM of original 3473 rats before merging\", x= \"off Diagonal\", y = \"Count\")\n```\n:::\n\n\nHere is the histogram of both the diagonal and off diagonal GRM for the 3551 rats after merging\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_rats_GRM <- ReadGRMBin(data.dir %&% \"all_rats_grm\")\ndiag <- as.data.frame(all_rats_GRM$diag) %>% rename(val = `all_rats_GRM$diag`)\nggplot(diag, aes(x = val)) + geom_histogram(binwidth = 0.03, colour=\"black\", fill=\"white\") + labs(title = \"Histogram of Diagonal of GRM of merged 3551 rats\", x= \"Diagonal\", y = \"Count\")\n\noff <- as.data.frame(all_rats_GRM$off) %>% rename(val = `all_rats_GRM$off`)\nggplot(off, aes(x = val)) + geom_histogram(binwidth = 0.03, colour=\"black\", fill=\"white\") + labs(title = \"Histogram of Off Diagonal of GRM of merged 3551 rats\", x= \" off Diagonal\", y = \"Count\")\n```\n:::\n\n\n\nThat small group to the right of the histogram are  the relatedness between the 40ish rats that overlap between Tyson and Apurva's mice. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ntyson_rats <- read_tsv(data.dir %&% \"list_of_tyson_rats.txt\", col_names = TRUE)\nall_rats <- readGRM(data.dir %&% \"all_rats_grm\")\nall_rats$grm$id1 <- all_rats$id[match(all_rats$grm$id1, rownames(all_rats$id)), 1]\nall_rats$grm$id2 <- all_rats$id[match(all_rats$grm$id2, rownames(all_rats$id)), 1]\n\noverlap_rats <- all_rats$grm \noverlap_rats <- overlap_rats %>% filter(id1 %in% tyson_rats$V1 | id2 %in% tyson_rats$V1) %>% filter(grm <= -1)\nhead(overlap_rats)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}