{
  "hash": "61cca7775c6007445145827cf45682ab",
  "result": {
    "markdown": "---\ntitle: \"Coregulation_across_Tissues_Species\"\nauthor: \"Natasha Santhanam\"\ndate: \"2/14/2022\"\noutput: html_document\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(devtools)\nlibrary(broom)\nlibrary(data.table)\nlibrary(RSQLite)\nlibrary(Hmisc)\n\"%&%\" = function(a,b) paste(a,b,sep=\"\")\ndir <- \"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/\"\nset.seed(777)\n```\n:::\n\n\n1. Correlation between genes within each tissue and then\ncalculate correlation of the correlation between genes across tissues\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilelist <- list.files(\"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/prediXcan/metabolic_traits\", pattern = \"predict.txt\", full.names = TRUE)\north.rats <- read_tsv(dir %&% \"expression/ortholog_genes_rats_humans.tsv\", col_names = TRUE)\n```\n:::\n\n\nGenerate Correlation Matrices for 100 rats - compare predicted Expression across tissues\n\n::: {.cell}\n\n```{.r .cell-code}\nnames <- read_tsv(filelist[1]) %>% select(c(FID))\n\nfor(i in 1:100) {\n  id = sample(names$FID, size = 1)\n  tempo <- data.frame(gene = as.character())\n  for(fila in filelist) {\n    name <- substr(fila, 89,90)\n    tis <- fread(fila) %>% filter(FID == id) %>% pivot_longer(!c(FID, IID), names_to = \"gene\", values_to = name) %>% select(-c(FID, IID))\n    tempo <- full_join(tempo, tis,  by = \"gene\")\n  } \n  tempo <- tempo %>% mutate(var = apply(tempo[,-1], 1, var)) %>% na.omit()\n  saveRDS(tempo, dir %&% \"prediXcan/GREx_comp/cor_tis_per_ind/\" %&% id %&% \".GREx.mat.RDS\")\n}\n```\n:::\n\n\n\nCheck heatmap of some individuals\n\n::: {.cell}\n\n```{.r .cell-code}\ni1 <- readRDS(\"/Users/natashasanthanam/Downloads/00077E6712.cor.mat.RDS\")\ni2 <- readRDS(\"/Users/natashasanthanam/Downloads/00077E7788.cor.mat.RDS\")\n\nmelted_i1 <- melt(i1, na.rm = TRUE)\nmelted_i2 <- melt(i2, na.rm = TRUE)\n\np1= ggplot(data = melted_i1, aes(x=Var1, y=Var2, fill=value)) + \n  geom_tile() + theme(\n  axis.title.x = element_blank(),\n  axis.title.y = element_blank(),) + ggtitle(\"00077E6712\") + theme(aspect.ratio = 1)\np2= ggplot(data = melted_i2, aes(x=Var1, y=Var2, fill=value)) + \n  geom_tile() + theme(\n  axis.title.x = element_blank(),\n  axis.title.y = element_blank(),) + ggtitle(\"00077E7788\") + theme(aspect.ratio = 1)\n\nggarrange(p1, p2, ncol=2)\n```\n:::\n\n\nLook at all genes across tissues in one individual\nEvidence of shared regulation across tissues\n\n::: {.cell}\n\n```{.r .cell-code}\ni3 = readRDS(\"/Users/natashasanthanam/Downloads/00077E83E3.GREx.mat.RDS\") %>% dplyr::select(-c(gene, var))\npairs(i3)\n```\n:::\n\n\n\n2.  Co-regulation Shared Across Species\n\n::: {.cell}\n\n```{.r .cell-code}\ngene_ids <- data.frame(id = fread(filelist[1]) %>% select(-c(FID, IID)) %>%  colnames()\nfor(fila in filelist[2:length(filelist)]) {\n  df <- data.frame(id = fread(fila) %>% select(-c(FID, IID)) %>%  colnames())\n  gene_ids <- inner_join(gene_ids, df, by = \"id\")\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngtf <- fread(dir %&% \"Box_files/gtf.txt\", header = TRUE)\ngtf <-  gtf[match(tempo$id, gtf$Gene),]\n \nfor(i in 1:20) {\n  tempo <- gtf %>% filter(Chr == i) %>% select(c(Gene))\n  if(nrow(tempo) == 0 ) {\n  i = i+1  \n  }\n  else {\n  df <- data.frame(row = as.character(), column = as.character())\n  for(fila in filelist) {\n    tis <- substr(fila, 58,59)\n    expr <- as.data.frame(fread(fila) %>% select(-c(FID, IID)))\n    expr <- expr[,intersect(tempo$Gene, colnames(expr))]\n    res2<-rcorr(as.matrix(expr[,]))\n  d2 <- flattenCorrMatrix(res2$r, res2$P)\n    colnames(d2)[3] = tis\n    colnames(d2)[4] = paste(\"p\", tis, sep = \"_\")\n    df <- full_join(df, d2, by = c(\"row\", \"column\"))\n  }\n  saveRDS(df, dir %&% \"prediXcan/GREx_comp/cor_genes_per_chr/chr\" %&% i %&% \".RDS\" )\n  }\n}\n```\n:::\n\n\n\nSave correlation of coregulation across tissues\n\n::: {.cell}\n\n```{.r .cell-code}\ncoreg.dir <- \"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/prediXcan/GREx_comp/cor_genes_per_chr\"\nfilelist <- list.files(coreg.dir, pattern = \".RDS\", full.names = TRUE)\n\nfor(fila in filelist) {\n  tempo <- readRDS(fila) %>% select(c(row, column, Ac, Il, Pl, Lh, Vo)) %>%\n  i <- substr(fila, 89, str_length(fila)- 4)\n  cor.mat <-  cor(tempo[,3:7])\n  saveRDS(cor.mat, dir %&% \"prediXcan/GREx_comp/cor_genes_per_chr/cor_coreg_chr\" %&% i %&% \".RDS\")\n}\n```\n:::\n\n\n\nGraph of Correlation of Coregulation across tissues\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.dir <- \"/Users/natashasanthanam/CRI/\"\nfilelist <- list.files(data.dir, pattern=\"cor_coreg\", full.names = TRUE)\ncorr_coreg <- list()\n\nfor(fila in filelist) {\n  i <- match(fila, filelist)\n  corr_coreg[[i]] <- readRDS(fila)\n}\n```\n:::\n\n\nGenerate Coregulation in Humans (GTEx)\n\nFirst generate predicted expression in G1000 using GTEx models\n\n::: {.cell}\n\n```{.bash .cell-code}\nconda activate imlabtools\nexport METAXCAN=/gpfs/data/im-lab/nas40t2/natasha/GTEX_Analysis/MetaXcan/software\nexport GENO=/gpfs/data/im-lab/nas40t2/Data/dbGaP/Transcriptome/G1000/imputed_hrc1.1\nexport MODEL=/gpfs/data/im-lab/nas40t2/Data/PredictDB/GTEx_v8/models_v1/eqtl/ctimp\nexport RESULTS=/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/PTRS_weights/PGP\nexport DATA=/gpfs/data/im-lab/nas40t2/natasha/GTEX_Analysis/predixcan\n\nprintf \"Predict expression\\n\\n\"\n\npython3 $METAXCAN/Predict.py \\\n--model_db_path $MODEL/ctimp_$TISSUE.db \\\n--model_db_snp_key varID \\\n--vcf_genotypes $GENO/chr*.dose.vcf.gz  \\\n--vcf_mode genotyped \\\n--liftover $DATA/hg19ToHg38.over.chain.gz  \\\n--on_the_fly_mapping METADATA \"chr{}_{}_{}_{}_b38\" \\\n--prediction_output $RESULTS/G1000__$TISSUE.predict.txt \\\n--prediction_summary_output $RESULTS/G1000__$TISSUE.summary.txt \\\n--verbosity 9 \\\n--throw\n\nTISSUE=Brain_Cerebellum\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflattenCorrMatrix <- function(cormat, pmat) {\n  ut <- upper.tri(cormat)\n  data.frame(\n    row = rownames(cormat)[row(cormat)[ut]],\n    column = rownames(cormat)[col(cormat)[ut]],\n    cor  =(cormat)[ut],\n    p = pmat[ut]\n    )\n}\n```\n:::\n\n\n\nCalculate Coregulation between genes in GTEx\n\n::: {.cell}\n\n```{.r .cell-code}\ngtf <- fread(\"/gpfs/data/im-lab/nas40t2/natasha/GTEX_Analysis/annotations_gencode_v26.tsv\", header = TRUE)\n\n for(i in 1:20) {\n  tempo <- gtf %>% filter(chromosome == paste(\"chr\", i, sep=\"\")) %>% select(c(gene_id))\n  expr <- as.data.frame( fread(\"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/prediXcan/GREx_comp/G1000_less_mem__Brain_Cerebellum.predict.txt\")) %>% select(-c(FID, IID)) \n colnames(expr) = sapply(strsplit(colnames(expr), \"\\\\.\"), `[`, 1)\n    expr <- expr[, intersect(tempo$gene_id, colnames(expr))]\n   res2<-rcorr(as.matrix(expr[,]))\n  d2 <- flattenCorrMatrix(res2$r, res2$P)\nsaveRDS(d2, dir %&% \"prediXcan/GREx_comp/cor_GTEx_genes_per_chr/GTEx_chr\" %&% i %&% \".RDS\" )\n }\n\n#Can also calculate correlation between genes in GTEx for all genes\nexpr <- as.data.frame( fread(\"/gpfs/data/im-lab/nas40t2/natasha/rat_genomics/prediXcan/GREx_comp/G1000_less_mem__Brain_Cerebellum.predict.txt\")) %>% select(-c(FID, IID)) \n colnames(expr) = sapply(strsplit(colnames(expr), \"\\\\.\"), `[`, 1)\n res2<-rcorr(as.matrix(expr[,]))\n  d2 <- flattenCorrMatrix(res2$r, res2$P)\n```\n:::\n\n\n\n\nCheck if Coregualtion is preserved across species\n\n\n\n\n\n\nPlot Coregulation across species\n\n::: {.cell}\n\n```{.r .cell-code}\np.dir <- \"/Users/natashasanthanam/CRI/\"\nfilelist <- list.files(p.dir, pattern = \"all\", full.names = TRUE)\n\nfor(fila in filelist) {\n  df <- readRDS(fila)\n  pairs(df)\n}\n```\n:::\n\n\n\nHeatmap ordered with TSS\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonly_GTEx <- readRDS(\"/Users/natashasanthanam/Downloads/cor_pred_expr_GTEx_all_genes.RDS\") %>% select(-c(p)) %>% mutate(start = gtf[match(only_GTEx$row, gtf$gene_id), 5]$start) %>% distinct(row, column, .keep_all = TRUE)\n\nGTEx_ordered <- only_GTEx[sort(only_GTEx$start),]\n\nGTEx_chr2_genes <- only_GTEx[na.omit(match(gtf$gene_id, only_GTEx$row)), ]\n\np3= ggplot(data = GTEx_ordered, aes(x=row, y=column, fill=cor)) + \n  geom_tile() + theme(\n  axis.title.x = element_blank(),\n  axis.title.y = element_blank(), axis.text = element_text(size = 2)) + ggtitle(\"Heatmap for predicted expression in GTEx Cerebellum\")\np3\n```\n:::\n",
    "supporting": [
      "Coregualtion_across_Tissues_Species_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}